name: Release Go Module

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "README.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
      - ".github/**"

permissions:
  contents: write
  pull-requests: read

jobs:
  verify:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip release]') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-workspace

      - name: Run pre-release checks
        run: |
          go mod verify
          go test -v -cover -race ./...

  release:
    runs-on: ubuntu-latest
    needs: verify
    if: ${{ !contains(github.event.head_commit.message, '[skip release]') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-workspace

      - name: Run go mod verify
        run: go mod verify

      - name: Read version from spec file
        id: read_version
        run: |
          # Check if specs.json exists
          if [ ! -f "specs.json" ]; then
            echo "âŒ specs.json file not found!"
            exit 1
          fi

          # Extract version from specs.json
          VERSION=$(jq -r '.version' specs.json)

          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
            echo "âŒ Version not found in specs.json or is empty"
            exit 1
          fi

          # Ensure version starts with 'v'
          if [[ ! $VERSION =~ ^v ]]; then
            VERSION="v$VERSION"
          fi

          # Validate version format (semantic versioning)
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ Invalid version format in specs.json: ${VERSION}"
            echo "Expected format: x.y.z (semantic versioning)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Version from specs.json: $VERSION"

      - name: Get previous tag
        id: previous_tag
        run: |
          git fetch --tags
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Check if version already exists
        id: check_version
        run: |
          SPEC_VERSION="${{ steps.read_version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.tag }}"

          # Check if tag already exists
          if git rev-parse "$SPEC_VERSION" >/dev/null 2>&1; then
            echo "âŒ Tag $SPEC_VERSION already exists!"
            echo "Please update the version in specs.json to create a new release."
            exit 1
          fi

          # Check if version is the same as previous (no version bump)
          if [ "$SPEC_VERSION" = "$PREVIOUS_TAG" ]; then
            echo "â„¹ï¸  Version $SPEC_VERSION hasn't changed from previous release"
            echo "This indicates specs.json was updated with non-version changes only"
            echo "Skipping release creation..."
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if version is newer than previous
          if [ "$PREVIOUS_TAG" != "v0.0.0" ]; then
            # Remove 'v' prefix for comparison
            SPEC_NUM=${SPEC_VERSION#v}
            PREV_NUM=${PREVIOUS_TAG#v}

            # Simple version comparison (works for semantic versioning)
            if printf '%s\n' "$PREV_NUM" "$SPEC_NUM" | sort -V | head -n1 | grep -q "^$SPEC_NUM$"; then
              echo "âš ï¸  Warning: Version $SPEC_VERSION appears to be older than previous version $PREVIOUS_TAG"
              echo "Proceeding anyway..."
            fi
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "âœ… Version validation passed: $PREVIOUS_TAG â†’ $SPEC_VERSION"

      - name: Generate changelog
        id: changelog
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          SPEC_VERSION="${{ steps.read_version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.tag }}"

          # Get description from specs.json if available
          CHANGELOG=$(cat ".github/release/${SPEC_VERSION}.md")

          if [ "$PREVIOUS_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          fi

          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create tag
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          SPEC_VERSION="${{ steps.read_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a $SPEC_VERSION -m "Release $SPEC_VERSION"
          git push origin $SPEC_VERSION

      - name: Create GitHub Release
        if: steps.check_version.outputs.should_release == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.read_version.outputs.version }}
          release_name: Release ${{ steps.read_version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: Notify Go Proxy
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          SPEC_VERSION="${{ steps.read_version.outputs.version }}"
          MODULE_NAME=$(go list -m)
          curl -f "https://proxy.golang.org/${MODULE_NAME}/@v/${SPEC_VERSION}.info" || true

          echo "âœ… Release ${SPEC_VERSION} created successfully!"
          echo "ðŸ“¦ Go module: ${MODULE_NAME}@${SPEC_VERSION}"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${SPEC_VERSION}"

      - name: Skip release notification
        if: steps.check_version.outputs.should_release == 'false'
        run: |
          echo "ðŸ”„ Workflow completed without creating a release"
          echo "ðŸ’¡ To create a new release, update the 'version' field in specs.json"
          echo ""
          echo "Current version in specs.json: ${{ steps.read_version.outputs.version }}"
          echo "Latest released version: ${{ steps.previous_tag.outputs.tag }}"
